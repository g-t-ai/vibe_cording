<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>HTMLリアルタイムチェック</title>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #container {
      display: flex;
      height: 100%;
      width: 100%;
    }
    .pane {
      height: 100%;
      overflow: auto;
      font-family: monospace;
      padding: 10px;
    }
    #pane1 { width: 33.33%; background: #fff; display: flex; flex-direction: column; }
    #pane2 { width: 33.33%; background: #f8f8f8; border-left: 1px solid #ccc; border-right: 1px solid #ccc; user-select: none; pointer-events: none; }
    #pane3 { width: 33.33%; background: #fff; }

    .resizer {
      width: 5px;
      cursor: col-resize;
      background: #ccc;
      height: 100%;
    }

    textarea {
      width: 100%;
      height: 100%;
      resize: none;
      font-size: 14px;
      font-family: monospace;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .header {
      font-weight: bold;
      background: #eee;
      padding: 5px 10px;
      border-bottom: 1px solid #ccc;
    }

    #copyButton {
      padding: 6px 12px;
      margin: 5px 10px;
      font-size: 14px;
      align-self: flex-start;
    }

    code[class*="language-"], pre[class*="language-"] {
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="pane1" class="pane">
      <div class="header">ソース原本・コピー</div>
      <textarea id="htmlInput" placeholder="ここにHTMLを入力..."></textarea>
      <button id="copyButton">コピー</button>
    </div>
    <div class="resizer" id="resizer1"></div>

    <div id="pane2" class="pane">
      <div class="header">精査用※コピー不可</div>
      <pre><code id="treeView" class="language-markup"></code></pre>
    </div>
    <div class="resizer" id="resizer2"></div>

    <div id="pane3" class="pane">
      <div class="header">プレビュー</div>
      <iframe id="preview"></iframe>
    </div>
  </div>

  <script>
    const input = document.getElementById("htmlInput");
    const preview = document.getElementById("preview");
    const tree = document.getElementById("treeView");
    const copyButton = document.getElementById("copyButton");

    function escapeHTML(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderTree(node, depth = 0) {
      if (!node) return '';
      let result = '';
      for (const child of node.childNodes) {
        if (child.nodeType === Node.ELEMENT_NODE) {
          const tag = child.tagName.toLowerCase();
          const attrs = Array.from(child.attributes)
            .map(attr => `${attr.name}="${attr.value}"`).join(' ');
          const open = `<${tag}${attrs ? ' ' + attrs : ''}>`;
          const close = `</${tag}>`;

          result += '  '.repeat(depth) + open + '\n';
          result += renderTree(child, depth + 1);
          result += '  '.repeat(depth) + close + '\n';
        } else if (child.nodeType === Node.TEXT_NODE && child.textContent.trim()) {
          result += '  '.repeat(depth) + child.textContent.trim() + '\n';
        }
      }
      return result;
    }

    function update() {
      const html = input.value;
      const doc = preview.contentDocument || preview.contentWindow.document;
      doc.open();
      doc.write(html);
      doc.close();

      try {
        const parser = new DOMParser();
        const parsed = parser.parseFromString(html, 'text/html');
        tree.innerHTML = escapeHTML(renderTree(parsed.body));
        Prism.highlightAll();
      } catch (e) {
        tree.textContent = '構文エラー';
      }
    }

    input.addEventListener('input', update);
    window.addEventListener('DOMContentLoaded', update);

    copyButton.addEventListener('click', () => {
      navigator.clipboard.writeText(input.value)
        .then(() => alert("コピーしました"))
        .catch(err => alert("コピーに失敗しました"));
    });

    function setupResizer(resizer, leftPane, rightPane) {
      let isDragging = false;

      resizer.addEventListener('mousedown', function (e) {
        isDragging = true;
        document.body.style.cursor = 'col-resize';
        e.preventDefault();
      });

      document.addEventListener('mousemove', function (e) {
        if (!isDragging) return;

        const container = document.getElementById('container');
        const totalWidth = container.offsetWidth;
        const offsetLeft = container.getBoundingClientRect().left;

        const x = e.clientX - offsetLeft;
        const leftWidth = x - resizer.offsetWidth / 2;
        const rightWidth = totalWidth - leftWidth - resizer.offsetWidth;

        if (leftWidth > 50 && rightWidth > 50) {
          leftPane.style.width = `${(leftWidth / totalWidth) * 100}%`;
          rightPane.style.width = `${(rightWidth / totalWidth) * 100}%`;
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        document.body.style.cursor = 'default';
      });
    }

    setupResizer(document.getElementById('resizer1'), document.getElementById('pane1'), document.getElementById('pane2'));
    setupResizer(document.getElementById('resizer2'), document.getElementById('pane2'), document.getElementById('pane3'));
  </script>
</body>
</html>
