<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>UserNote</title>

  <link rel="stylesheet" href="theme.css">

<style>
   html,body{
  margin:0;padding:0;height:100%;width:100%;overflow:hidden;
  font-family:sans-serif;display:flex;flex-direction:column;
  background:linear-gradient(180deg,#0e1120,#0a0d16); /* ← テーマの背景 */
  color:var(--ink);
  }
  #app-container{flex-grow:1;display:flex;flex-direction:column;height:100%}

  /* ==== ヘッダー（スリム） ==== */
  #menu-bar{
  height:40px;
  background:var(--panel);
  border-bottom:1px solid #2a2f49;
  display:flex;align-items:center;padding:0 8px;gap:8px;white-space:nowrap;overflow-x:auto
  }
  #menu-bar button{
  padding:5px 10px;cursor:pointer;
  background:#101428;border:1px solid #2a2f49;color:var(--ink);border-radius:8px;
  }
  #menu-bar button:hover{ box-shadow:0 0 0 2px rgba(122,162,255,.15) inset; border-color:var(--brand); }
  #header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
  #header-wordcount{font-size:13px;opacity:.9}
  #sidebar{
  width:260px;min-width:150px;max-width:520px;
  background:var(--panel);border-right:1px solid #2a2f49;
  display:flex;flex-direction:column;resize:horizontal;overflow:auto
  }
  #sidebar-header{ padding:6px;border-bottom:1px solid #2a2f49;display:flex;gap:6px }

  /* 文字サイズ */
  #font-size-slider-container{display:flex;align-items:center;gap:6px}
  #font-size-slider{width:120px}

  #main-content{flex-grow:1;display:flex;overflow:hidden}
  #note-list{flex-grow:1;overflow:auto}
  .folder-container,.note-item{border-bottom:1px solid #eee}

  /* ==== フォルダ ==== */
  .folder-header{
  display:flex;align-items:center;padding:10px;cursor:pointer;
  background:#131626;color:var(--ink);font-weight:bold;font-size:14px;user-select:none
  }
  .folder-toggle{margin-right:8px;transition:.2s;display:inline-block;width:12px}
  .folder-container[data-is-open="false"] .folder-toggle{transform:rotate(-90deg)}
  .folder-header.drag-over{ outline:2px dashed var(--ok); background:#0f1324 }
  .folder-notes{ padding-left:20px;min-height:5px }
  .folder-notes.drag-over{ background:#0f1324 }

  .folder-rename-btn,.folder-delete-btn{margin-left:5px;padding:2px 6px;cursor:pointer;border:none;background:none;font-size:14px;opacity:.6}
  .folder-rename-btn:hover,.folder-delete-btn:hover{opacity:1;background:#ffcccc;border-radius:4px}
  .folder-container[data-is-open="false"] .folder-notes{display:none}

  /* ==== メモ ==== */
  .note-item{ padding:10px 10px 10px 15px;display:flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;-webkit-user-drag:element }
  .note-item:hover{ background:#131626 }
  .note-item.active{ background:#101428;font-weight:bold }
  .delete-button{margin-left:auto;padding:2px 6px;border-radius:4px;font-size:14px;visibility:hidden;opacity:.6}
  .note-title-input{
  width:100%;padding:10px 15px;border:none;border-bottom:1px solid #2a2f49;
  font-size:20px;font-weight:bold;box-sizing:border-box;outline:none;background:#0f1324;color:var(--ink)
  }
  #note-editor{
  flex-grow:1;width:100%;padding:15px;border:none;outline:none;resize:none;box-sizing:border-box;
  font-size:16px;line-height:1.6;overflow:auto;white-space:pre-wrap;word-wrap:break-word;
  background:#0f1324;color:var(--ink)
  }
  .note-item:hover .delete-button{visibility:visible}
  .delete-button:hover{opacity:1;background:#ffcccc}

  /* ==== 右ペイン ==== */
  #editor-area-container{flex-grow:1;display:flex;flex-direction:column;overflow:hidden}
  
  /* ==== ステータスバー ==== */
  #status-bar{
  height:25px;background:var(--panel);border-top:1px solid #2a2f49;
  display:flex;align-items:center;padding:0 10px;font-size:12px;gap:8px;color:var(--muted)
  }
  #status-bar span{margin-right:12px}
  .kbd{
  font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
  background:#0b0f1f;border:1px solid #2a2f49;border-bottom-width:2px;border-radius:4px;padding:1px 4px;font-size:12px;color:var(--ink)
  }

  /* ==== ルート戻しドロップ領域 ==== */
 /* 既存の .root-drop-area 定義の後ろに追記して上書き */
  .root-drop-area{
    background: var(--panel);
    color: var(--muted);
    border-top: 1px dashed #2a2f49;
  }
  .root-drop-area.drag-over{
    background: #0f1324;
    outline: 1px dashed var(--ok);
    color: var(--ink);
  }
  /* リンクが入る場合の保険 */
  .root-drop-area a{ color: inherit; text-decoration: none; }
  .root-drop-area a:hover{ color: var(--brand); }

  /* モーダル */
  .modal-backdrop{ position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50 }
  .modal{ background:#101428;width:min(520px,90vw);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.4);padding:14px 14px 10px;color:var(--ink);border:1px solid #2a2f49 }
  .modal header{ font-weight:bold;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;color:var(--ink) }
  .modal .close-btn{ border:none;background:none;font-size:20px;cursor:pointer;opacity:.7;color:var(--ink) }
  .modal .close-btn:hover{ opacity:1 }

  /* 検索置換モーダル */
  .modal .row{display:flex;gap:8px;margin:8px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  /* エクスポートモーダル */
  .export-options{display:grid;grid-template-columns:1fr;gap:10px}  
  /* 入力系 */
  .modal input[type="text"]{ flex:1;padding:8px 10px;border:1px solid #2a2f49;border-radius:6px;font-size:14px;background:#0f1324;color:var(--ink) }
  .modal .actions button{ padding:6px 10px;cursor:pointer;background:#101428;border:1px solid #2a2f49;color:var(--ink);border-radius:8px }
  .export-options button{ padding:10px 12px;font-size:14px;cursor:pointer;text-align:left;border:1px solid #2a2f49;border-radius:8px;background:#0f1324;color:var(--ink) }
  .export-options button:hover{ background:#131626 }
  :root {
  /* paper mode (editor only) */
  --paper-bg: #f6f7fb;
  --paper-ink: #0b0d14;
  --paper-muted: #5b6278;
  --paper-border: #e0e3ef;
  --paper-selection: #cfe3ff;
}
  /* ===== Paperモード：本文エリアだけ明るく ===== */
body.paper .note-title-input{
  background: var(--paper-bg);
  color: var(--paper-ink);
  border-bottom: 1px solid var(--paper-border);
}

/* 本文を紙色にする（必須） */
body.paper #note-editor{
  background: var(--paper-bg);
  color: var(--paper-ink);
  line-height: 1.7;
  font-size: 16px;
  letter-spacing: .01em;
  border-top: 1px solid var(--paper-border);
  caret-color: var(--brand);
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
}

/* 選択範囲の配色（追加） */
body.paper #note-editor::selection {
  background: var(--paper-selection);
  color: var(--paper-ink);
}

/* プレースホルダー/選択色も紙側に合わせる */
body.paper #note-editor::placeholder { color: var(--paper-muted); }
body.paper ::selection { background: var(--paper-selection); color: var(--paper-ink); }

/* エディタのスクロールバーを薄く（ブラウザ対応範囲で） */
body.paper #note-editor::-webkit-scrollbar { width: 10px; }
body.paper #note-editor::-webkit-scrollbar-thumb {
  background: #d6dbeb;
  border-radius: 8px;
  border: 2px solid var(--paper-bg);
}

</style>
</head>
<body>
  <div id="app-container">
    <div id="menu-bar">
      <button id="new-note-button">新規メモ</button>
      <button id="delete-note-button">削除</button>
      <button id="save-button">保存</button>

      <!-- 検索置換をポップアップで -->
      <button id="open-find-dialog">検索/置換</button>

      <!-- エクスポート（モーダルを開く） -->
      <button id="open-export-dialog">エクスポート</button>
      <button id="togglePaper" class="btn">Paperモード</button>

      <div id="header-right">
        <div id="font-size-slider-container">
          <span>文字:</span>
          <input type="range" id="font-size-slider" min="10" max="30" value="16">
          <span id="font-size-value">16px</span>
        </div>
        <span id="header-wordcount">文字数: 0</span>
      </div>
    </div>

    <div id="main-content">
      <div id="sidebar">
        <div id="sidebar-header">
          <button id="new-folder-button" style="flex:1">新規フォルダ</button>
        </div>
        <div id="note-list"></div>
        <!-- ルート戻し -->
        <div id="root-drop-area" class="root-drop-area" title="ここにドロップでフォルダから外す">↩ ルートへ戻す（ドラッグ＆ドロップ）</div>
      </div>

      <div id="editor-area-container">
        <input type="text" id="note-title-input" class="note-title-input" placeholder="タイトル">
        <textarea id="note-editor" spellcheck="false" placeholder="ここにメモを書きます..."></textarea>
      </div>
    </div>

    <div id="status-bar">
      <span id="status-save">保存状態: -</span> | 
      <span id="status-mode">モード: 標準</span>
      <span style="margin-left:auto">ショートカット: <span class="kbd">Ctrl/⌘</span>+<span class="kbd">F</span> で検索</span>
    </div>
  </div>

  <!-- 検索置換モーダル -->
  <div id="find-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="find-modal-title">
      <header>
        <div id="find-modal-title">検索 / 置換</div>
        <button class="close-btn" id="find-close" aria-label="閉じる">×</button>
      </header>
      <div class="row"><input id="find-text" type="text" placeholder="検索語"></div>
      <div class="row"><input id="replace-text" type="text" placeholder="置換語（空なら置換しない）"></div>
      <div class="opts">
        <label><input type="checkbox" id="regex-mode"> 正規表現</label>
        <label><input type="checkbox" id="match-case"> 大文字小文字を区別</label>
      </div>
      <div class="actions">
        <button id="find-next-button">次を検索</button>
        <button id="replace-all-button">すべて置換</button>
      </div>
    </div>
  </div>

  <!-- エクスポートモーダル -->
  <div id="export-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="export-modal-title">
      <header>
        <div id="export-modal-title">エクスポート</div>
        <button class="close-btn" id="export-close" aria-label="閉じる">×</button>
      </header>
      <div class="export-options">
        <button id="export-all-button">📦 全体エクスポート（JSON）</button>
        <button id="export-current-button">📝 現在のメモ（.txt）</button>
      </div>
    </div>
  </div>

<script>
  /* ====== 状態 ====== */
  let notes = [];
  let folders = [];
  let uiState = { openFolderIds: [] };
  let currentNoteIds = { main: null };
  let lastFindIndex = -1; // 検索位置

  /* ====== ユーティリティ ====== */
  function createNote(content = '', title = '新規メモ', folderId = null) {
    const id = Date.now().toString() + Math.random().toString(36).slice(2,7);
    return { id, title, content, folderId, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
  }
  function createFolder(name) {
    const id = 'folder-' + Date.now().toString() + Math.random().toString(36).slice(2,7);
    return { id, name };
  }

  function updateSaveStatus(text){ document.getElementById('status-save').textContent = '保存状態: ' + text; }
  function saveDataToLocalStorage() {
    saveCurrentNoteContent();
    try {
      localStorage.setItem('usernote-app-data', JSON.stringify({notes, folders, uiState}));
      updateSaveStatus('保存済み');
    } catch(e){ console.error(e); updateSaveStatus('保存エラー'); }
  }
  function loadDataFromLocalStorage() {
    try {
      const raw = localStorage.getItem('usernote-app-data');
      if(raw){
        const data = JSON.parse(raw);
        notes = data.notes || [];
        folders = data.folders || [];
        uiState = data.uiState || { openFolderIds: [] };
      }
    } catch(e){ console.error(e); notes=[]; folders=[]; uiState={openFolderIds:[]}; }
  }

  /* ====== サイドバー描画 & DnD ====== */
  function renderSidebar() {
    const noteList = document.getElementById('note-list');
    noteList.innerHTML = '';

    // フォルダ
    folders.forEach(folder=>{
      const isOpen = uiState.openFolderIds.includes(folder.id);
      const container = document.createElement('div');
      container.className='folder-container';
      container.dataset.folderId = folder.id;
      container.dataset.isOpen = isOpen;

      const header = document.createElement('div');
      header.className='folder-header';

      const toggle = document.createElement('span');
      toggle.className='folder-toggle';
      toggle.textContent='▼';
      header.appendChild(toggle);

      const nameSpan = document.createElement('span');
      nameSpan.className='folder-name';
      nameSpan.textContent = folder.name;
      header.appendChild(nameSpan);

      const renameBtn = document.createElement('button');
      renameBtn.className='folder-rename-btn';
      renameBtn.textContent='✎';
      renameBtn.title='フォルダ名変更';
      renameBtn.onclick = e=>{
        e.stopPropagation();
        const nv = prompt('新しいフォルダ名:', folder.name);
        if(nv && nv.trim()){ folder.name = nv.trim(); renderSidebar(); saveDataToLocalStorage(); }
      };
      header.appendChild(renameBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.className='folder-delete-btn';
      deleteBtn.textContent='🗑';
      deleteBtn.title='フォルダ削除';
      deleteBtn.onclick = e=>{
        e.stopPropagation();
        if(!confirm('このフォルダを削除しますか？中のメモはルートに移動されます。')) return;
        notes.forEach(n=>{ if(n.folderId===folder.id) n.folderId=null; });
        folders = folders.filter(f=>f.id!==folder.id);
        renderSidebar(); saveDataToLocalStorage();
      };
      header.appendChild(deleteBtn);

      // 開閉（クリック）
      header.addEventListener('click', ()=>{
        const i = uiState.openFolderIds.indexOf(folder.id);
        if(i>-1) uiState.openFolderIds.splice(i,1); else uiState.openFolderIds.push(folder.id);
        renderSidebar(); saveDataToLocalStorage();
      });

      // ★ ヘッダーにドロップ対応（閉じていても入れられる）
      header.addEventListener('dragover', e=>{ e.preventDefault(); header.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
      header.addEventListener('dragleave', ()=> header.classList.remove('drag-over'));
      header.addEventListener('drop', e=>{
        e.preventDefault(); header.classList.remove('drag-over');
        const noteId = e.dataTransfer.getData('text/plain');
        const n = notes.find(x=>x.id===noteId);
        if(n){ n.folderId = folder.id; saveDataToLocalStorage(); renderSidebar(); }
      });

      container.appendChild(header);

      const folderNotes = document.createElement('div');
      folderNotes.className='folder-notes';
      // 中身リストにもドロップ受け取り
      folderNotes.addEventListener('dragover', e=>{ e.preventDefault(); folderNotes.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
      folderNotes.addEventListener('dragleave', ()=> folderNotes.classList.remove('drag-over'));
      folderNotes.addEventListener('drop', e=>{
        e.preventDefault(); folderNotes.classList.remove('drag-over');
        const noteId = e.dataTransfer.getData('text/plain');
        const n = notes.find(x=>x.id===noteId);
        if(n){ n.folderId = folder.id; saveDataToLocalStorage(); renderSidebar(); }
      });

      const inFolder = notes.filter(n=>n.folderId===folder.id);
      inFolder.forEach(n=> folderNotes.appendChild(createNoteItemElement(n)));
      container.appendChild(folderNotes);

      noteList.appendChild(container);
    });

    // ルートのメモ（フォルダ外）
    const rootList = document.createElement('div');
    const roots = notes.filter(n=>!n.folderId);
    roots.forEach(n=> rootList.appendChild(createNoteItemElement(n)));
    noteList.appendChild(rootList);
  }

  function createNoteItemElement(note){
    const el = document.createElement('div');
    el.className='note-item';
    if(note.id===currentNoteIds.main) el.classList.add('active');
    el.dataset.id = note.id;

    // ドラッグ設定
    el.draggable = true;
    el.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', note.id);
      e.dataTransfer.effectAllowed='move';
    });

    const title = document.createElement('span');
    title.textContent = note.title || '無題';
    el.appendChild(title);

    const del = document.createElement('span');
    del.className='delete-button';
    del.innerHTML='🗑';
    del.title='メモを削除';
    del.onclick = e=>{ e.stopPropagation(); deleteNote(note.id); };
    el.appendChild(del);

    el.onclick = ()=> loadNoteIntoPane(note.id);
    return el;
  }

  function deleteNote(id){
    if(!confirm('このメモを完全に削除しますか？')) return;
    notes = notes.filter(n=>n.id!==id);
    if(currentNoteIds.main===id) {
      currentNoteIds.main=null;
      document.getElementById('note-title-input').value='';
      document.getElementById('note-editor').value='';
    }
    renderSidebar(); saveDataToLocalStorage(); updateStatusBar();
  }

  function createNewNote(){
    const n = createNote();
    notes.unshift(n);
    renderSidebar(); loadNoteIntoPane(n.id); saveDataToLocalStorage();
  }

  function loadNoteIntoPane(id){
    const n = notes.find(x=>x.id===id); if(!n) return;
    currentNoteIds.main=id;
    document.getElementById('note-title-input').value = n.title;
    document.getElementById('note-editor').value = n.content;
    updateStatusBar(); renderSidebar();
  }

  function saveCurrentNoteContent(){
    const id = currentNoteIds.main; if(!id) return;
    const n = notes.find(x=>x.id===id); if(!n) return;
    const title = document.getElementById('note-title-input').value.trim() || '無題';
    const content = document.getElementById('note-editor').value;
    if(n.title!==title || n.content!==content){
      n.title = title; n.content = content; n.updatedAt = new Date().toISOString();
      renderSidebar(); // タイトルの反映
    }
  }

  function updateStatusBar(){
    const content = document.getElementById('note-editor').value || '';
    document.getElementById('header-wordcount').textContent = `文字数: ${content.length}`;
  }

  /* ====== ルート戻しドロップ ====== */
  function setupRootDrop(){
    const root = document.getElementById('root-drop-area');
    root.addEventListener('dragover', e=>{ e.preventDefault(); root.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
    root.addEventListener('dragleave', ()=> root.classList.remove('drag-over'));
    root.addEventListener('drop', e=>{
      e.preventDefault(); root.classList.remove('drag-over');
      const noteId = e.dataTransfer.getData('text/plain');
      const n = notes.find(x=>x.id===noteId);
      if(n){ n.folderId = null; saveDataToLocalStorage(); renderSidebar(); }
    });
  }

  /* ====== エクスポート ====== */
  function downloadBlob(filename, text){
    const blob = new Blob([text], {type:'application/octet-stream'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }
  function exportAll(){
    const data = { notes, folders, uiState };
    downloadBlob(`UserNote_all_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`, JSON.stringify(data,null,2));
  }
  function exportCurrent(){
    const id = currentNoteIds.main; if(!id){ alert('メモが選択されていません'); return; }
    const n = notes.find(x=>x.id===id); if(!n){ alert('メモが見つかりません'); return; }
    const name = (n.title||'memo').replace(/[\\/:*?"<>|]/g,'_').slice(0,60) || 'memo';
    downloadBlob(`${name}.txt`, n.content||'');
  }

  /* ====== 検索・置換（ポップアップ） ====== */
  function openModal(id){ const m=document.getElementById(id); m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
  function closeModal(id){ const m=document.getElementById(id); m.style.display='none'; m.setAttribute('aria-hidden','true'); }

  function openFindDialog(){ openModal('find-modal'); setTimeout(()=> document.getElementById('find-text').focus(), 0); }
  function findNext(){
    const editor = document.getElementById('note-editor');
    const text = editor.value;
    const query = document.getElementById('find-text').value;
    const isRegex = document.getElementById('regex-mode').checked;
    const matchCase = document.getElementById('match-case').checked;
    if(!query){ return; }
    let flags = 'g'; if(!matchCase) flags += 'i';
    let regex;
    try{ regex = isRegex ? new RegExp(query, flags) : new RegExp(escapeRegExp(query), flags); }
    catch(e){ alert('正規表現が不正です'); return; }
    const startPos = editor.selectionEnd ?? 0;
    regex.lastIndex = startPos;
    const m = regex.exec(text) || (regex.lastIndex=0, regex.exec(text));
    if(m){ selectRange(editor, m.index, m.index + m[0].length); lastFindIndex = m.index + m[0].length; }
    else{ alert('見つかりませんでした'); }
  }
  function replaceAll(){
    const editor = document.getElementById('note-editor');
    const query = document.getElementById('find-text').value;
    const repl  = document.getElementById('replace-text').value;
    const isRegex = document.getElementById('regex-mode').checked;
    const matchCase = document.getElementById('match-case').checked;
    if(!query){ return; }
    const src = editor.value;
    let flags = 'g'; if(!matchCase) flags += 'i';
    try{
      const regex = isRegex ? new RegExp(query, flags) : new RegExp(escapeRegExp(query), flags);
      const replaced = src.replace(regex, repl);
      if(replaced !== src){
        editor.value = replaced;
        saveCurrentNoteContent();
        updateStatusBar();
        saveDataToLocalStorage();
        alert('置換しました');
      }else{
        alert('置換対象がありませんでした');
      }
    }catch(e){ alert('正規表現が不正です'); }
  }
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function selectRange(textarea, start, end){
    textarea.focus();
    textarea.setSelectionRange(start, end);
    const before = textarea.value.slice(0, start);
    const line = before.split('\n').length;
    const lineHeight = 20;
    textarea.scrollTop = (line-1) * lineHeight - textarea.clientHeight/3;
  }

  /* ====== イベント登録 ====== */
  document.getElementById('new-note-button').addEventListener('click', createNewNote);
  document.getElementById('new-folder-button').addEventListener('click', ()=>{
    const name = prompt('新しいフォルダ名:'); if(name && name.trim()){ folders.push(createFolder(name.trim())); renderSidebar(); saveDataToLocalStorage(); }
  });
  document.getElementById('save-button').addEventListener('click', saveDataToLocalStorage);
  document.getElementById('delete-note-button').addEventListener('click', ()=>{
    const id = currentNoteIds.main; if(!id) return alert('メモが選択されていません');
    deleteNote(id);
  });

  document.getElementById('note-editor').addEventListener('input', ()=>{ saveCurrentNoteContent(); updateStatusBar(); saveDataToLocalStorage(); });
  document.getElementById('note-title-input').addEventListener('input', ()=>{ saveCurrentNoteContent(); saveDataToLocalStorage(); });

  // 文字サイズ
  const fontSlider = document.getElementById('font-size-slider');
  const fontValue  = document.getElementById('font-size-value');
  fontSlider.addEventListener('input', ()=>{
    document.getElementById('note-editor').style.fontSize = fontSlider.value + 'px';
    fontValue.textContent = fontSlider.value + 'px';
  });

  // 検索モーダル
  document.getElementById('open-find-dialog').addEventListener('click', openFindDialog);
  document.getElementById('find-close').addEventListener('click', ()=> closeModal('find-modal'));
  document.getElementById('find-modal').addEventListener('click', (e)=>{ if(e.target.id==='find-modal') closeModal('find-modal'); });
  document.getElementById('find-next-button').addEventListener('click', findNext);
  document.getElementById('replace-all-button').addEventListener('click', replaceAll);
  // Ctrl/⌘+F で開く
  document.addEventListener('keydown', (e)=>{
    const isMac = navigator.platform.toUpperCase().includes('Mac'.toUpperCase());
    if((isMac ? e.metaKey : e.ctrlKey) && e.key.toLowerCase()==='f'){
      e.preventDefault(); openFindDialog();
    }
  });

  // エクスポートモーダル
  document.getElementById('open-export-dialog').addEventListener('click', ()=> openModal('export-modal'));
  document.getElementById('export-close').addEventListener('click', ()=> closeModal('export-modal'));
  document.getElementById('export-modal').addEventListener('click', (e)=>{ if(e.target.id==='export-modal') closeModal('export-modal'); });
  document.getElementById('export-all-button').addEventListener('click', ()=>{ exportAll(); closeModal('export-modal'); });
  document.getElementById('export-current-button').addEventListener('click', ()=>{ exportCurrent(); closeModal('export-modal'); });

  // ルート戻し
  function setupRootDrop(){
    const root = document.getElementById('root-drop-area');
    root.addEventListener('dragover', e=>{ e.preventDefault(); root.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
    root.addEventListener('dragleave', ()=> root.classList.remove('drag-over'));
    root.addEventListener('drop', e=>{
      e.preventDefault(); root.classList.remove('drag-over');
      const noteId = e.dataTransfer.getData('text/plain');
      const n = notes.find(x=>x.id===noteId);
      if(n){ n.folderId = null; saveDataToLocalStorage(); renderSidebar(); }
    });
  }

  // エクセルからの貼り付け時にダブルクォートが2重になる問題を解決
  function setupPasteHandler() {
    const editor = document.getElementById('note-editor');
    const titleInput = document.getElementById('note-title-input');
    
    function handlePaste(element) {
      // 少し遅延させて、貼り付けが完了してから処理を実行
      setTimeout(function() {
        let text = '';
        
        // 要素の種類に応じてテキストを取得
        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
          text = element.value;
        } else if (element.contentEditable === 'true') {
          text = element.textContent || element.innerText;
        }
        
        // ダブルクォートが2重になっている箇所を修正
        if (text.includes('""')) {
          const correctedText = text.replace(/""/g, '"');
          
          // 修正されたテキストを設定
          if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            element.value = correctedText;
          } else if (element.contentEditable === 'true') {
            element.textContent = correctedText;
          }
          
          // 入力イベントを発火させて、他のスクリプトに変更を通知
          const inputEvent = new Event('input', { bubbles: true });
          element.dispatchEvent(inputEvent);
        }
      }, 10); // 10msの遅延
    }
    
    // エディターとタイトル入力欄に貼り付けイベントリスナーを追加
    editor.addEventListener('paste', function(e) {
      handlePaste(editor);
    });
    
    titleInput.addEventListener('paste', function(e) {
      handlePaste(titleInput);
    });
  }

  // 初期化
  window.addEventListener('DOMContentLoaded', ()=>{
    loadDataFromLocalStorage();
    renderSidebar();
    setupRootDrop();
    setupPasteHandler(); // 貼り付けハンドラーを設定
    updateStatusBar();
  });
  
  const editor = document.getElementById("note-editor");

  // 入力中にタブを改行に変換
  editor.addEventListener("input", () => {
    const pos = editor.selectionStart;
    editor.value = editor.value.replace(/\t/g, "\n");
    editor.selectionEnd = pos;
  });
  
(function(){
  const KEY = 'paperMode';
  const apply = v => document.body.classList.toggle('paper', v === '1');

  // 初期化（保存値を適用）
  apply(localStorage.getItem(KEY) || '0');

  // ボタンがDOMにない場合は自動で右端に追加
  let btn = document.getElementById('togglePaper');
  if(!btn){
    const bar = document.getElementById('menu-bar');
    if(bar){
      btn = document.createElement('button');
      btn.id = 'togglePaper';
      btn.className = 'btn';
      btn.textContent = 'Paperモード';
      bar.appendChild(btn);
    }
  }

  // クリックで切替
  btn?.addEventListener('click', () => {
    const on = document.body.classList.toggle('paper');
    localStorage.setItem(KEY, on ? '1' : '0');
  });
})();
</script>
</body>
</html>
