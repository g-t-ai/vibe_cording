<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UserNote</title>
<style>
  html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden;font-family:sans-serif;display:flex;flex-direction:column}
  #app-container{flex-grow:1;display:flex;flex-direction:column;height:100%}

  /* ==== ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¹ãƒªãƒ ï¼‰ ==== */
  #menu-bar{height:40px;background:#e0e0e0;border-bottom:1px solid #ccc;display:flex;align-items:center;padding:0 8px;gap:8px;white-space:nowrap;overflow-x:auto}
  #menu-bar button{padding:5px 10px;cursor:pointer}
  #header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
  #header-wordcount{font-size:13px;opacity:.9}

  /* æ–‡å­—ã‚µã‚¤ã‚º */
  #font-size-slider-container{display:flex;align-items:center;gap:6px}
  #font-size-slider{width:120px}

  /* ==== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ==== */
  #main-content{flex-grow:1;display:flex;overflow:hidden}
  #sidebar{width:260px;min-width:150px;max-width:520px;background:#f4f4f4;border-right:1px solid #ddd;display:flex;flex-direction:column;resize:horizontal;overflow:auto}
  #sidebar-header{padding:6px;border-bottom:1px solid #ddd;display:flex;gap:6px}
  #note-list{flex-grow:1;overflow:auto}
  .folder-container,.note-item{border-bottom:1px solid #eee}

  /* ==== ãƒ•ã‚©ãƒ«ãƒ€ ==== */
  .folder-header{display:flex;align-items:center;padding:10px;cursor:pointer;background:#e9e9e9;font-weight:bold;font-size:14px;user-select:none}
  .folder-header.drag-over{outline:2px dashed #5ab85a;background:#e8ffe8}
  .folder-toggle{margin-right:8px;transition:.2s;display:inline-block;width:12px}
  .folder-container[data-is-open="false"] .folder-toggle{transform:rotate(-90deg)}
  .folder-header .folder-name{margin-left:8px;flex:1}
  .folder-rename-btn,.folder-delete-btn{margin-left:5px;padding:2px 6px;cursor:pointer;border:none;background:none;font-size:14px;opacity:.6}
  .folder-rename-btn:hover,.folder-delete-btn:hover{opacity:1;background:#ffcccc;border-radius:4px}
  .folder-notes{padding-left:20px;min-height:5px}
  .folder-notes.drag-over{background:#e0f0ff}
  .folder-container[data-is-open="false"] .folder-notes{display:none}

  /* ==== ãƒ¡ãƒ¢ ==== */
  .note-item{padding:10px 10px 10px 15px;display:flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;-webkit-user-drag:element}
  .note-item:hover{background:#e9e9e9}
  .note-item.active{background:#d0d0d0;font-weight:bold}
  .delete-button{margin-left:auto;padding:2px 6px;border-radius:4px;font-size:14px;visibility:hidden;opacity:.6}
  .note-item:hover .delete-button{visibility:visible}
  .delete-button:hover{opacity:1;background:#ffcccc}

  /* ==== å³ãƒšã‚¤ãƒ³ ==== */
  #editor-area-container{flex-grow:1;display:flex;flex-direction:column;overflow:hidden}
  .note-title-input{width:100%;padding:10px 15px;border:none;border-bottom:1px solid #ddd;font-size:20px;font-weight:bold;box-sizing:border-box;outline:none;background:#fff}
  #note-editor{flex-grow:1;width:100%;padding:15px;border:none;outline:none;resize:none;box-sizing:border-box;font-size:16px;line-height:1.6;overflow:auto;white-space:pre-wrap;word-wrap:break-word}

  /* ==== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ ==== */
  #status-bar{height:25px;background:#e0e0e0;border-top:1px solid #ccc;display:flex;align-items:center;padding:0 10px;font-size:12px;gap:8px}
  #status-bar span{margin-right:12px}

  /* ==== ãƒ«ãƒ¼ãƒˆæˆ»ã—ãƒ‰ãƒ­ãƒƒãƒ—é ˜åŸŸ ==== */
  .root-drop-area{padding:8px 10px;min-height:16px;border-top:1px dashed #ccc;background:#fafafa;position:sticky;bottom:0}
  .root-drop-area.drag-over{background:#e8ffe8;outline:1px dashed #5ab85a}

  /* ==== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±é€šï¼‰ ==== */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;width:min(520px,90vw);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.2);padding:14px 14px 10px}
  .modal header{font-weight:bold;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
  .modal .close-btn{border:none;background:none;font-size:20px;cursor:pointer;opacity:.7}
  .modal .close-btn:hover{opacity:1}

  /* æ¤œç´¢ç½®æ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal .row{display:flex;gap:8px;margin:8px 0}
  .modal input[type="text"]{flex:1;padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:14px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .modal .actions button{padding:6px 10px;cursor:pointer}
  .modal .opts{display:flex;gap:12px;align-items:center;font-size:13px;color:#333}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#f6f6f6;border:1px solid #ddd;border-bottom-width:2px;border-radius:4px;padding:1px 4px;font-size:12px}

  /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */
  .export-options{display:grid;grid-template-columns:1fr;gap:10px}
  .export-options button{padding:10px 12px;font-size:14px;cursor:pointer;text-align:left;border:1px solid #ddd;border-radius:8px;background:#fafafa}
  .export-options button:hover{background:#f0f0f0}
</style>
</head>
<body>
  <div id="app-container">
    <div id="menu-bar">
      <button id="new-note-button">æ–°è¦ãƒ¡ãƒ¢</button>
      <button id="delete-note-button">å‰Šé™¤</button>
      <button id="save-button">ä¿å­˜</button>

      <!-- æ¤œç´¢ç½®æ›ã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ -->
      <button id="open-find-dialog">æ¤œç´¢/ç½®æ›</button>

      <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼‰ -->
      <button id="open-export-dialog">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>

      <div id="header-right">
        <div id="font-size-slider-container">
          <span>æ–‡å­—:</span>
          <input type="range" id="font-size-slider" min="10" max="30" value="16">
          <span id="font-size-value">16px</span>
        </div>
        <span id="header-wordcount">æ–‡å­—æ•°: 0</span>
      </div>
    </div>

    <div id="main-content">
      <div id="sidebar">
        <div id="sidebar-header">
          <button id="new-folder-button" style="flex:1">æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€</button>
        </div>
        <div id="note-list"></div>
        <!-- ãƒ«ãƒ¼ãƒˆæˆ»ã— -->
        <div id="root-drop-area" class="root-drop-area" title="ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰å¤–ã™">â†© ãƒ«ãƒ¼ãƒˆã¸æˆ»ã™ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰</div>
      </div>

      <div id="editor-area-container">
        <input type="text" id="note-title-input" class="note-title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        <textarea id="note-editor" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’æ›¸ãã¾ã™..."></textarea>
      </div>
    </div>

    <div id="status-bar">
      <span id="status-save">ä¿å­˜çŠ¶æ…‹: -</span> | 
      <span id="status-mode">ãƒ¢ãƒ¼ãƒ‰: æ¨™æº–</span>
      <span style="margin-left:auto">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: <span class="kbd">Ctrl/âŒ˜</span>+<span class="kbd">F</span> ã§æ¤œç´¢</span>
    </div>
  </div>

  <!-- æ¤œç´¢ç½®æ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="find-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="find-modal-title">
      <header>
        <div id="find-modal-title">æ¤œç´¢ / ç½®æ›</div>
        <button class="close-btn" id="find-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </header>
      <div class="row"><input id="find-text" type="text" placeholder="æ¤œç´¢èª"></div>
      <div class="row"><input id="replace-text" type="text" placeholder="ç½®æ›èªï¼ˆç©ºãªã‚‰ç½®æ›ã—ãªã„ï¼‰"></div>
      <div class="opts">
        <label><input type="checkbox" id="regex-mode"> æ­£è¦è¡¨ç¾</label>
        <label><input type="checkbox" id="match-case"> å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥</label>
      </div>
      <div class="actions">
        <button id="find-next-button">æ¬¡ã‚’æ¤œç´¢</button>
        <button id="replace-all-button">ã™ã¹ã¦ç½®æ›</button>
      </div>
    </div>
  </div>

  <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="export-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="export-modal-title">
      <header>
        <div id="export-modal-title">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
        <button class="close-btn" id="export-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </header>
      <div class="export-options">
        <button id="export-all-button">ğŸ“¦ å…¨ä½“ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰</button>
        <button id="export-current-button">ğŸ“ ç¾åœ¨ã®ãƒ¡ãƒ¢ï¼ˆ.txtï¼‰</button>
      </div>
    </div>
  </div>

<script>
  /* ====== çŠ¶æ…‹ ====== */
  let notes = [];
  let folders = [];
  let uiState = { openFolderIds: [] };
  let currentNoteIds = { main: null };
  let lastFindIndex = -1; // æ¤œç´¢ä½ç½®

  /* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
  function createNote(content = '', title = 'æ–°è¦ãƒ¡ãƒ¢', folderId = null) {
    const id = Date.now().toString() + Math.random().toString(36).slice(2,7);
    return { id, title, content, folderId, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
  }
  function createFolder(name) {
    const id = 'folder-' + Date.now().toString() + Math.random().toString(36).slice(2,7);
    return { id, name };
  }

  function updateSaveStatus(text){ document.getElementById('status-save').textContent = 'ä¿å­˜çŠ¶æ…‹: ' + text; }
  function saveDataToLocalStorage() {
    saveCurrentNoteContent();
    try {
      localStorage.setItem('usernote-app-data', JSON.stringify({notes, folders, uiState}));
      updateSaveStatus('ä¿å­˜æ¸ˆã¿');
    } catch(e){ console.error(e); updateSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼'); }
  }
  function loadDataFromLocalStorage() {
    try {
      const raw = localStorage.getItem('usernote-app-data');
      if(raw){
        const data = JSON.parse(raw);
        notes = data.notes || [];
        folders = data.folders || [];
        uiState = data.uiState || { openFolderIds: [] };
      }
    } catch(e){ console.error(e); notes=[]; folders=[]; uiState={openFolderIds:[]}; }
  }

  /* ====== ã‚µã‚¤ãƒ‰ãƒãƒ¼æç”» & DnD ====== */
  function renderSidebar() {
    const noteList = document.getElementById('note-list');
    noteList.innerHTML = '';

    // ãƒ•ã‚©ãƒ«ãƒ€
    folders.forEach(folder=>{
      const isOpen = uiState.openFolderIds.includes(folder.id);
      const container = document.createElement('div');
      container.className='folder-container';
      container.dataset.folderId = folder.id;
      container.dataset.isOpen = isOpen;

      const header = document.createElement('div');
      header.className='folder-header';

      const toggle = document.createElement('span');
      toggle.className='folder-toggle';
      toggle.textContent='â–¼';
      header.appendChild(toggle);

      const nameSpan = document.createElement('span');
      nameSpan.className='folder-name';
      nameSpan.textContent = folder.name;
      header.appendChild(nameSpan);

      const renameBtn = document.createElement('button');
      renameBtn.className='folder-rename-btn';
      renameBtn.textContent='âœ';
      renameBtn.title='ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´';
      renameBtn.onclick = e=>{
        e.stopPropagation();
        const nv = prompt('æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€å:', folder.name);
        if(nv && nv.trim()){ folder.name = nv.trim(); renderSidebar(); saveDataToLocalStorage(); }
      };
      header.appendChild(renameBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.className='folder-delete-btn';
      deleteBtn.textContent='ğŸ—‘';
      deleteBtn.title='ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤';
      deleteBtn.onclick = e=>{
        e.stopPropagation();
        if(!confirm('ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿä¸­ã®ãƒ¡ãƒ¢ã¯ãƒ«ãƒ¼ãƒˆã«ç§»å‹•ã•ã‚Œã¾ã™ã€‚')) return;
        notes.forEach(n=>{ if(n.folderId===folder.id) n.folderId=null; });
        folders = folders.filter(f=>f.id!==folder.id);
        renderSidebar(); saveDataToLocalStorage();
      };
      header.appendChild(deleteBtn);

      // é–‹é–‰ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰
      header.addEventListener('click', ()=>{
        const i = uiState.openFolderIds.indexOf(folder.id);
        if(i>-1) uiState.openFolderIds.splice(i,1); else uiState.openFolderIds.push(folder.id);
        renderSidebar(); saveDataToLocalStorage();
      });

      // â˜… ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œï¼ˆé–‰ã˜ã¦ã„ã¦ã‚‚å…¥ã‚Œã‚‰ã‚Œã‚‹ï¼‰
      header.addEventListener('dragover', e=>{ e.preventDefault(); header.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
      header.addEventListener('dragleave', ()=> header.classList.remove('drag-over'));
      header.addEventListener('drop', e=>{
        e.preventDefault(); header.classList.remove('drag-over');
        const noteId = e.dataTransfer.getData('text/plain');
        const n = notes.find(x=>x.id===noteId);
        if(n){ n.folderId = folder.id; saveDataToLocalStorage(); renderSidebar(); }
      });

      container.appendChild(header);

      const folderNotes = document.createElement('div');
      folderNotes.className='folder-notes';
      // ä¸­èº«ãƒªã‚¹ãƒˆã«ã‚‚ãƒ‰ãƒ­ãƒƒãƒ—å—ã‘å–ã‚Š
      folderNotes.addEventListener('dragover', e=>{ e.preventDefault(); folderNotes.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
      folderNotes.addEventListener('dragleave', ()=> folderNotes.classList.remove('drag-over'));
      folderNotes.addEventListener('drop', e=>{
        e.preventDefault(); folderNotes.classList.remove('drag-over');
        const noteId = e.dataTransfer.getData('text/plain');
        const n = notes.find(x=>x.id===noteId);
        if(n){ n.folderId = folder.id; saveDataToLocalStorage(); renderSidebar(); }
      });

      const inFolder = notes.filter(n=>n.folderId===folder.id);
      inFolder.forEach(n=> folderNotes.appendChild(createNoteItemElement(n)));
      container.appendChild(folderNotes);

      noteList.appendChild(container);
    });

    // ãƒ«ãƒ¼ãƒˆã®ãƒ¡ãƒ¢ï¼ˆãƒ•ã‚©ãƒ«ãƒ€å¤–ï¼‰
    const rootList = document.createElement('div');
    const roots = notes.filter(n=>!n.folderId);
    roots.forEach(n=> rootList.appendChild(createNoteItemElement(n)));
    noteList.appendChild(rootList);
  }

  function createNoteItemElement(note){
    const el = document.createElement('div');
    el.className='note-item';
    if(note.id===currentNoteIds.main) el.classList.add('active');
    el.dataset.id = note.id;

    // ãƒ‰ãƒ©ãƒƒã‚°è¨­å®š
    el.draggable = true;
    el.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', note.id);
      e.dataTransfer.effectAllowed='move';
    });

    const title = document.createElement('span');
    title.textContent = note.title || 'ç„¡é¡Œ';
    el.appendChild(title);

    const del = document.createElement('span');
    del.className='delete-button';
    del.innerHTML='ğŸ—‘';
    del.title='ãƒ¡ãƒ¢ã‚’å‰Šé™¤';
    del.onclick = e=>{ e.stopPropagation(); deleteNote(note.id); };
    el.appendChild(del);

    el.onclick = ()=> loadNoteIntoPane(note.id);
    return el;
  }

  function deleteNote(id){
    if(!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    notes = notes.filter(n=>n.id!==id);
    if(currentNoteIds.main===id) {
      currentNoteIds.main=null;
      document.getElementById('note-title-input').value='';
      document.getElementById('note-editor').value='';
    }
    renderSidebar(); saveDataToLocalStorage(); updateStatusBar();
  }

  function createNewNote(){
    const n = createNote();
    notes.unshift(n);
    renderSidebar(); loadNoteIntoPane(n.id); saveDataToLocalStorage();
  }

  function loadNoteIntoPane(id){
    const n = notes.find(x=>x.id===id); if(!n) return;
    currentNoteIds.main=id;
    document.getElementById('note-title-input').value = n.title;
    document.getElementById('note-editor').value = n.content;
    updateStatusBar(); renderSidebar();
  }

  function saveCurrentNoteContent(){
    const id = currentNoteIds.main; if(!id) return;
    const n = notes.find(x=>x.id===id); if(!n) return;
    const title = document.getElementById('note-title-input').value.trim() || 'ç„¡é¡Œ';
    const content = document.getElementById('note-editor').value;
    if(n.title!==title || n.content!==content){
      n.title = title; n.content = content; n.updatedAt = new Date().toISOString();
      renderSidebar(); // ã‚¿ã‚¤ãƒˆãƒ«ã®åæ˜ 
    }
  }

  function updateStatusBar(){
    const content = document.getElementById('note-editor').value || '';
    document.getElementById('header-wordcount').textContent = `æ–‡å­—æ•°: ${content.length}`;
  }

  /* ====== ãƒ«ãƒ¼ãƒˆæˆ»ã—ãƒ‰ãƒ­ãƒƒãƒ— ====== */
  function setupRootDrop(){
    const root = document.getElementById('root-drop-area');
    root.addEventListener('dragover', e=>{ e.preventDefault(); root.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
    root.addEventListener('dragleave', ()=> root.classList.remove('drag-over'));
    root.addEventListener('drop', e=>{
      e.preventDefault(); root.classList.remove('drag-over');
      const noteId = e.dataTransfer.getData('text/plain');
      const n = notes.find(x=>x.id===noteId);
      if(n){ n.folderId = null; saveDataToLocalStorage(); renderSidebar(); }
    });
  }

  /* ====== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ====== */
  function downloadBlob(filename, text){
    const blob = new Blob([text], {type:'application/octet-stream'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }
  function exportAll(){
    const data = { notes, folders, uiState };
    downloadBlob(`UserNote_all_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`, JSON.stringify(data,null,2));
  }
  function exportCurrent(){
    const id = currentNoteIds.main; if(!id){ alert('ãƒ¡ãƒ¢ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
    const n = notes.find(x=>x.id===id); if(!n){ alert('ãƒ¡ãƒ¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    const name = (n.title||'memo').replace(/[\\/:*?"<>|]/g,'_').slice(0,60) || 'memo';
    downloadBlob(`${name}.txt`, n.content||'');
  }

  /* ====== æ¤œç´¢ãƒ»ç½®æ›ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ ====== */
  function openModal(id){ const m=document.getElementById(id); m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
  function closeModal(id){ const m=document.getElementById(id); m.style.display='none'; m.setAttribute('aria-hidden','true'); }

  function openFindDialog(){ openModal('find-modal'); setTimeout(()=> document.getElementById('find-text').focus(), 0); }
  function findNext(){
    const editor = document.getElementById('note-editor');
    const text = editor.value;
    const query = document.getElementById('find-text').value;
    const isRegex = document.getElementById('regex-mode').checked;
    const matchCase = document.getElementById('match-case').checked;
    if(!query){ return; }
    let flags = 'g'; if(!matchCase) flags += 'i';
    let regex;
    try{ regex = isRegex ? new RegExp(query, flags) : new RegExp(escapeRegExp(query), flags); }
    catch(e){ alert('æ­£è¦è¡¨ç¾ãŒä¸æ­£ã§ã™'); return; }
    const startPos = editor.selectionEnd ?? 0;
    regex.lastIndex = startPos;
    const m = regex.exec(text) || (regex.lastIndex=0, regex.exec(text));
    if(m){ selectRange(editor, m.index, m.index + m[0].length); lastFindIndex = m.index + m[0].length; }
    else{ alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); }
  }
  function replaceAll(){
    const editor = document.getElementById('note-editor');
    const query = document.getElementById('find-text').value;
    const repl  = document.getElementById('replace-text').value;
    const isRegex = document.getElementById('regex-mode').checked;
    const matchCase = document.getElementById('match-case').checked;
    if(!query){ return; }
    const src = editor.value;
    let flags = 'g'; if(!matchCase) flags += 'i';
    try{
      const regex = isRegex ? new RegExp(query, flags) : new RegExp(escapeRegExp(query), flags);
      const replaced = src.replace(regex, repl);
      if(replaced !== src){
        editor.value = replaced;
        saveCurrentNoteContent();
        updateStatusBar();
        saveDataToLocalStorage();
        alert('ç½®æ›ã—ã¾ã—ãŸ');
      }else{
        alert('ç½®æ›å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      }
    }catch(e){ alert('æ­£è¦è¡¨ç¾ãŒä¸æ­£ã§ã™'); }
  }
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function selectRange(textarea, start, end){
    textarea.focus();
    textarea.setSelectionRange(start, end);
    const before = textarea.value.slice(0, start);
    const line = before.split('\n').length;
    const lineHeight = 20;
    textarea.scrollTop = (line-1) * lineHeight - textarea.clientHeight/3;
  }

  /* ====== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ====== */
  document.getElementById('new-note-button').addEventListener('click', createNewNote);
  document.getElementById('new-folder-button').addEventListener('click', ()=>{
    const name = prompt('æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€å:'); if(name && name.trim()){ folders.push(createFolder(name.trim())); renderSidebar(); saveDataToLocalStorage(); }
  });
  document.getElementById('save-button').addEventListener('click', saveDataToLocalStorage);
  document.getElementById('delete-note-button').addEventListener('click', ()=>{
    const id = currentNoteIds.main; if(!id) return alert('ãƒ¡ãƒ¢ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
    deleteNote(id);
  });

  document.getElementById('note-editor').addEventListener('input', ()=>{ saveCurrentNoteContent(); updateStatusBar(); saveDataToLocalStorage(); });
  document.getElementById('note-title-input').addEventListener('input', ()=>{ saveCurrentNoteContent(); saveDataToLocalStorage(); });

  // æ–‡å­—ã‚µã‚¤ã‚º
  const fontSlider = document.getElementById('font-size-slider');
  const fontValue  = document.getElementById('font-size-value');
  fontSlider.addEventListener('input', ()=>{
    document.getElementById('note-editor').style.fontSize = fontSlider.value + 'px';
    fontValue.textContent = fontSlider.value + 'px';
  });

  // æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('open-find-dialog').addEventListener('click', openFindDialog);
  document.getElementById('find-close').addEventListener('click', ()=> closeModal('find-modal'));
  document.getElementById('find-modal').addEventListener('click', (e)=>{ if(e.target.id==='find-modal') closeModal('find-modal'); });
  document.getElementById('find-next-button').addEventListener('click', findNext);
  document.getElementById('replace-all-button').addEventListener('click', replaceAll);
  // Ctrl/âŒ˜+F ã§é–‹ã
  document.addEventListener('keydown', (e)=>{
    const isMac = navigator.platform.toUpperCase().includes('Mac'.toUpperCase());
    if((isMac ? e.metaKey : e.ctrlKey) && e.key.toLowerCase()==='f'){
      e.preventDefault(); openFindDialog();
    }
  });

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('open-export-dialog').addEventListener('click', ()=> openModal('export-modal'));
  document.getElementById('export-close').addEventListener('click', ()=> closeModal('export-modal'));
  document.getElementById('export-modal').addEventListener('click', (e)=>{ if(e.target.id==='export-modal') closeModal('export-modal'); });
  document.getElementById('export-all-button').addEventListener('click', ()=>{ exportAll(); closeModal('export-modal'); });
  document.getElementById('export-current-button').addEventListener('click', ()=>{ exportCurrent(); closeModal('export-modal'); });

  // ãƒ«ãƒ¼ãƒˆæˆ»ã—
  function setupRootDrop(){
    const root = document.getElementById('root-drop-area');
    root.addEventListener('dragover', e=>{ e.preventDefault(); root.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
    root.addEventListener('dragleave', ()=> root.classList.remove('drag-over'));
    root.addEventListener('drop', e=>{
      e.preventDefault(); root.classList.remove('drag-over');
      const noteId = e.dataTransfer.getData('text/plain');
      const n = notes.find(x=>x.id===noteId);
      if(n){ n.folderId = null; saveDataToLocalStorage(); renderSidebar(); }
    });
  }

  // åˆæœŸåŒ–
  window.addEventListener('DOMContentLoaded', ()=>{
    loadDataFromLocalStorage();
    renderSidebar();
    setupRootDrop();
    updateStatusBar();
  });
</script>
</body>
</html>