<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDFツール（画像回転・ページ分割・結合・PDF回転）</title>
<!-- ライブラリ（CDN） -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  :root {
    --bg: #0b1020; --panel: #121a2f; --muted: #9fb0d0; --text: #eef3ff;
    --accent: #6aa3ff; --accent-2: #9bffe0; --border: #2a3557;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,"ヒラギノ角ゴ ProN","メイリオ",Arial}
  header{padding:28px 20px;text-align:center}
  header h1{margin:0;letter-spacing:.02em;font-size:clamp(22px,3vw,30px)}
  header p{margin:6px 0 0;color:var(--muted);font-size:14px}
  .container{width:min(1100px,92vw);margin:0 auto 48px;display:grid;gap:16px;grid-template-columns:1fr}
  @media (min-width:980px){.container{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
    border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 8px 28px rgba(0,0,0,.25)}
  .card h2{margin:0 0 12px;font-size:18px;display:flex;align-items:center;gap:8px}
  .sub{color:var(--muted);font-size:13px;margin:8px 0 14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row + .row{margin-top:10px}
  input[type="file"]{display:block;width:100%;padding:10px;border-radius:12px;background:#0f1630;border:1px dashed var(--border);color:var(--muted)}
  input[type="text"]{background:#0f1630;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;width:100%}
  .btn{appearance:none;border:1px solid var(--border);
    background:linear-gradient(180deg,rgba(106,163,255,.22),rgba(106,163,255,.08));
    color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .06s,box-shadow .2s,border-color .2s;font-weight:600}
  .btn:hover{border-color:#3c4d7a;box-shadow:0 6px 18px rgba(106,163,255,.18)}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn.secondary{background:transparent}
  .btn.success{background:linear-gradient(180deg,rgba(155,255,224,.25),rgba(155,255,224,.10))}
  .btn.warning{background:linear-gradient(180deg,rgba(255,210,140,.25),rgba(255,210,140,.10))}
  .preview-wrap{margin-top:12px;background:#0f1630;border:1px solid var(--border);border-radius:12px;padding:12px;display:grid;place-items:center;max-height:360px;overflow:auto}
  canvas,img.preview{max-width:100%;height:auto;border-radius:10px;border:1px solid #203058;background:#0a0f1e}
  .list{margin:8px 0 0;padding:0;list-style:none;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .list li{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#0f1630}
  .list li:last-child{border-bottom:none}
  .file-name{color:var(--text);font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:66%}
  .file-ctrls{display:flex;gap:8px}
  .chip{font-size:12px;color:var(--muted)}
  footer{text-align:center;color:var(--muted);padding:14px 0 28px;font-size:12px}
  .note{color:var(--muted);font-size:12px;line-height:1.6;margin-top:10px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .hint{color:var(--accent-2)}
</style>
</head>
<body>
  <header>
    <h1>PDFツール（画像回転・PDF回転・ページ分割・結合）</h1>
    <p>すべてブラウザ内で処理。ファイルはサーバーに送信されません。</p>
  </header>

  <main class="container">
    <!-- 画像 90度回転 -->
    <section class="card" id="img-rotator">
      <h2>🖼️ 画像を90°回転</h2>
      <p class="sub">JPG / PNG / WebP などを読み込み、90°ずつ回転して保存。</p>
      <input id="imgInput" type="file" accept="image/*" />
      <div class="row">
        <button class="btn" id="rotateBtn">90°回転</button>
        <button class="btn success" id="downloadImgBtn">画像をダウンロード</button>
        <span class="chip" id="imgInfo"></span>
      </div>
      <div class="preview-wrap"><canvas id="imgCanvas"></canvas></div>
      <p class="note">出力形式は元画像に合わせます。EXIFの向きは正規化。</p>
    </section>

    <!-- ★ 新機能：PDF ページ回転 -->
    <section class="card" id="pdf-rotator">
      <h2>🧭 PDFページを90°回転</h2>
      <p class="sub">PDFの全ページ、または指定範囲だけを90°（時計回り）回転して出力します。</p>
      <input id="rotatePdfInput" type="file" accept="application/pdf" />
      <div class="row">
        <button class="btn" id="rotateAllPdfBtn">全ページを90°回転してダウンロード</button>
      </div>
      <div class="row">
        <input id="rotateRangeInput" type="text" placeholder="回転するページ範囲：例 1-3,5,7-" />
        <button class="btn success" id="rotateRangePdfBtn">範囲だけ90°回転（PDF出力）</button>
      </div>
      <div class="row"><span class="chip" id="rotatePdfInfo"></span></div>
      <p class="note">ページ番号は <b>1 始まり</b>。例：<span class="mono">-2</span>（先頭〜2ページ）、<span class="mono">5-</span>（5ページ目以降すべて）。</p>
    </section>

    <!-- PDF ページ分割 -->
    <section class="card" id="pdf-splitter">
      <h2>✂️ PDFページ分割</h2>
      <p class="sub">全ページを1枚ずつ（ZIP）／範囲抽出で1つのPDFを作成。</p>
      <input id="splitPdfInput" type="file" accept="application/pdf" />
      <div class="row"><button class="btn warning" id="splitAllBtn">全ページを1枚ずつに分割（ZIP）</button></div>
      <div class="row">
        <input id="rangeInput" type="text" placeholder="抽出するページ：例 1-3,5,7-8" />
        <button class="btn" id="extractRangeBtn">範囲を抽出（PDF）</button>
      </div>
      <div class="note">
        例：<span class="mono">1-3,5,7-</span> / <span class="mono">-2</span>
        <br><span class="hint">ページ番号は 1 始まり</span>
      </div>
      <div class="row"><span class="chip" id="splitInfo"></span></div>
    </section>

    <!-- PDF 結合 -->
    <section class="card" id="pdf-merger">
      <h2>🔗 PDFページの統合（結合）</h2>
      <p class="sub">複数PDFを選んで順序調整 → 1つに結合。</p>
      <input id="mergePdfInput" type="file" accept="application/pdf" multiple />
      <ul class="list" id="mergeList"></ul>
      <div class="row">
        <button class="btn success" id="mergeBtn">結合してダウンロード</button>
        <span class="chip" id="mergeInfo"></span>
      </div>
      <p class="note">各PDFのページ順は保持されます。↑↓で並び替え可能。</p>
    </section>
  </main>

  <footer>作成：あなたの相棒ChatGPT。必要なら縦横反転・180°/270°対応もすぐ追加できるよ！</footer>

<script>
  // ========= 共通ユーティリティ =========
  const byId = (id) => document.getElementById(id);
  const formatBytes = (bytes) => {
    if (!bytes && bytes !== 0) return "";
    const units = ["B","KB","MB","GB"];
    let i=0,n=bytes; while(n>=1024 && i<units.length-1){n/=1024;i++}
    return n.toFixed(n>=10||i===0?0:1)+" "+units[i];
  };
  const downloadBlob = (blob, filename) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 200);
  };
  const getBaseName = (name) => name.replace(/\.[^.]+$/, "");
  const readAsArrayBuffer = (file) => new Promise((res, rej) => {
    const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(file);
  });

  // ========= 画像 90度回転 =========
  (function initImageRotate(){
    const imgInput = byId("imgInput");
    const canvas = byId("imgCanvas");
    const ctx = canvas.getContext("2d");
    const rotateBtn = byId("rotateBtn");
    const downloadBtn = byId("downloadImgBtn");
    const info = byId("imgInfo");

    let img = new Image();
    let currentRotation = 0;
    let mime = "image/png";

    function draw(){
      const rad = (currentRotation % 360) * Math.PI / 180;
      const w = img.naturalWidth, h = img.naturalHeight;
      const is90 = (currentRotation/90) % 2 !== 0;
      canvas.width = is90 ? h : w;
      canvas.height = is90 ? w : h;
      ctx.save();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.rotate(rad);
      ctx.drawImage(img, -w/2, -h/2);
      ctx.restore();
      info.textContent = `${canvas.width}×${canvas.height}px`;
    }

    imgInput.addEventListener("change",(e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      mime = file.type || "image/png";
      const url = URL.createObjectURL(file);
      img.onload = ()=>{ currentRotation=0; draw(); URL.revokeObjectURL(url); };
      img.onerror = ()=>{ info.textContent="画像の読み込みに失敗しました"; };
      img.src = url;
    });

    rotateBtn.addEventListener("click", ()=>{
      if(!img.src){ info.textContent="先に画像を選択してください"; return; }
      currentRotation = (currentRotation + 90) % 360; draw();
    });

    downloadBtn.addEventListener("click", ()=>{
      if(!img.src){ info.textContent="先に画像を選択してください"; return; }
      canvas.toBlob((blob)=>{
        if (blob) downloadBlob(blob, `rotated_${Date.now()}.${mime.includes("jpeg")||mime.includes("jpg")?"jpg":(mime.split("/")[1]||"png")}`);
      }, mime);
    });
  })();

  // ========= ページ範囲パーサ（1始まり→0始まり配列） =========
  function parsePageRanges(input, pageCount){
    if(!input || !pageCount) return [];
    const cleaned = input.replace(/\s+/g,""); if(!cleaned) return [];
    const parts = cleaned.split(",");
    const set = new Set();
    for(const part of parts){
      if(!part) continue;
      const m = part.match(/^(\d+)?-(\d+)?$/);
      if(m){
        let start = m[1] ? parseInt(m[1],10) : 1;
        let end   = m[2] ? parseInt(m[2],10) : pageCount;
        if(start<1) start=1; if(end>pageCount) end=pageCount;
        if(start>end) [start,end] = [end,start];
        for(let p=start; p<=end; p++) set.add(p-1);
      }else{
        const p = parseInt(part,10);
        if(!isNaN(p) && p>=1 && p<=pageCount) set.add(p-1);
      }
    }
    return Array.from(set).sort((a,b)=>a-b);
  }

  // ========= ★ PDF 回転（90°時計回り） =========
  (function initPdfRotate(){
    const input = byId("rotatePdfInput");
    const info = byId("rotatePdfInfo");
    const rotateAllBtn = byId("rotateAllPdfBtn");
    const rotateRangeBtn = byId("rotateRangePdfBtn");
    const rangeInput = byId("rotateRangeInput");

    let file = null;
    let pageCount = 0;

    input.addEventListener("change", async (e)=>{
      file = e.target.files?.[0] ?? null;
      info.textContent = "";
      if(!file) return;
      try{
        const bytes = await readAsArrayBuffer(file);
        const pdf = await PDFLib.PDFDocument.load(bytes);
        pageCount = pdf.getPageCount();
        info.textContent = `${file.name} : ${pageCount}ページ, ${formatBytes(file.size)}`;
      }catch(err){
        console.error(err);
        info.textContent = "PDFの読み込みに失敗しました";
      }
    });

    async function rotateAndDownload(targetPages /* 0-based array or null for all */){
      if(!file){ info.textContent="先にPDFを選択してください"; return; }
      try{
        info.textContent = "回転処理中…";
        const bytes = await readAsArrayBuffer(file);
        const pdfDoc = await PDFLib.PDFDocument.load(bytes);

        const indices = targetPages && targetPages.length>0
          ? targetPages
          : Array.from({length: pdfDoc.getPageCount()}, (_,i)=>i);

        indices.forEach(i=>{
          const page = pdfDoc.getPage(i);
          const current = (page.getRotation()?.angle ?? 0);
          page.setRotation(PDFLib.degrees((current + 90) % 360));
        });

        const outBytes = await pdfDoc.save();
        const base = getBaseName(file.name);
        downloadBlob(new Blob([outBytes], {type:"application/pdf"}), `${base}_rot90_${Date.now()}.pdf`);
        info.textContent = `完了：${indices.length}ページを90°回転しました`;
      }catch(err){
        console.error(err);
        info.textContent = "回転に失敗しました";
      }
    }

    rotateAllBtn.addEventListener("click", ()=> rotateAndDownload(null));

    rotateRangeBtn.addEventListener("click", ()=>{
      if(!file){ info.textContent="先にPDFを選択してください"; return; }
      if(!pageCount){ info.textContent="ページ数取得に失敗しました"; return; }
      const pages = parsePageRanges(rangeInput.value, pageCount);
      if(pages.length===0){ info.textContent="有効なページ範囲を入力してください"; return; }
      rotateAndDownload(pages);
    });
  })();

  // ========= PDF 分割 =========
  (function initPdfSplit(){
    const input = byId("splitPdfInput");
    const info = byId("splitInfo");
    const splitAllBtn = byId("splitAllBtn");
    const extractBtn = byId("extractRangeBtn");
    const rangeInput = byId("rangeInput");

    let file = null; let pageCount = 0;
    input.addEventListener("change", async (e)=>{
      file = e.target.files?.[0] ?? null; info.textContent = "";
      if(!file) return;
      try{
        const bytes = await readAsArrayBuffer(file);
        const pdfDoc = await PDFLib.PDFDocument.load(bytes);
        pageCount = pdfDoc.getPageCount();
        info.textContent = `${file.name} : ${pageCount}ページ, ${formatBytes(file.size)}`;
      }catch(err){ console.error(err); info.textContent="PDFの読み込みに失敗しました"; }
    });

    splitAllBtn.addEventListener("click", async ()=>{
      if(!file){ info.textContent="先にPDFを選択してください"; return; }
      try{
        info.textContent = "分割中…（ZIP作成）";
        const bytes = await readAsArrayBuffer(file);
        const src = await PDFLib.PDFDocument.load(bytes);
        const zip = new JSZip(); const base = getBaseName(file.name);
        for(let i=0; i<src.getPageCount(); i++){
          const out = await PDFLib.PDFDocument.create();
          const [copied] = await out.copyPages(src, [i]); out.addPage(copied);
          const pdfBytes = await out.save(); zip.file(`${base}_p${i+1}.pdf`, pdfBytes);
        }
        const blob = await zip.generateAsync({type:"blob"});
        saveAs(blob, `${base}_split_${Date.now()}.zip`);
        info.textContent = "完了：ZIPをダウンロードしました";
      }catch(err){ console.error(err); info.textContent="分割に失敗しました"; }
    });

    extractBtn.addEventListener("click", async ()=>{
      if(!file){ info.textContent="先にPDFを選択してください"; return; }
      if(!pageCount){ info.textContent="PDFページ数の取得に失敗しました"; return; }
      const ranges = parsePageRanges(rangeInput.value, pageCount);
      if(ranges.length===0){ info.textContent="有効なページ範囲を入力してください"; return; }
      try{
        info.textContent = "抽出中…";
        const bytes = await readAsArrayBuffer(file);
        const src = await PDFLib.PDFDocument.load(bytes);
        const out = await PDFLib.PDFDocument.create();
        const copied = await out.copyPages(src, ranges); copied.forEach(p=>out.addPage(p));
        const pdfBytes = await out.save();
        const base = getBaseName(file.name);
        downloadBlob(new Blob([pdfBytes], {type:"application/pdf"}), `${base}_extract_${Date.now()}.pdf`);
        info.textContent = `完了：${ranges.length}ページ抽出しました`;
      }catch(err){ console.error(err); info.textContent="抽出に失敗しました"; }
    });
  })();

  // ========= PDF 結合 =========
  (function initPdfMerge(){
    const input = byId("mergePdfInput");
    const list = byId("mergeList");
    const info = byId("mergeInfo");
    const mergeBtn = byId("mergeBtn");
    let files = [];

    function renderList(){
      list.innerHTML = "";
      files.forEach((f,idx)=>{
        const li=document.createElement("li");
        const name=document.createElement("div"); name.className="file-name"; name.textContent=f.file.name;
        const ctrls=document.createElement("div"); ctrls.className="file-ctrls";
        const up=document.createElement("button"); up.className="btn secondary"; up.textContent="↑"; up.title="上へ";
        up.onclick=()=>{ if(idx>0){ const t=files[idx-1]; files[idx-1]=files[idx]; files[idx]=t; renderList(); } };
        const down=document.createElement("button"); down.className="btn secondary"; down.textContent="↓"; down.title="下へ";
        down.onclick=()=>{ if(idx<files.length-1){ const t=files[idx+1]; files[idx+1]=files[idx]; files[idx]=t; renderList(); } };
        const del=document.createElement("button"); del.className="btn secondary"; del.textContent="削除"; del.title="リストから削除";
        del.onclick=()=>{ files = files.filter(x=>x.id!==f.id); renderList(); };
        ctrls.append(up,down,del); li.append(name,ctrls); list.appendChild(li);
      });
      if(files.length===0){ const li=document.createElement("li"); li.innerHTML='<span class="chip">ファイルを選択すると一覧が表示されます</span>'; list.appendChild(li); }
      info.textContent = files.length ? `${files.length}ファイル選択中` : "";
    }

    input.addEventListener("change",(e)=>{
      const sel = Array.from(e.target.files || []);
      for(const f of sel){
        const id = `${f.name}_${f.size}_${f.lastModified}_${Math.random().toString(36).slice(2,8)}`;
        files.push({file:f,id});
      }
      renderList();
    });

    mergeBtn.addEventListener("click", async ()=>{
      if(files.length===0){ info.textContent="PDFを選択してください"; return; }
      try{
        info.textContent="結合中…";
        const out = await PDFLib.PDFDocument.create();
        for(const f of files){
          const bytes = await readAsArrayBuffer(f.file);
          const src = await PDFLib.PDFDocument.load(bytes);
          const idx = Array.from({length: src.getPageCount()}, (_,i)=>i);
          const copied = await out.copyPages(src, idx);
          copied.forEach(p=>out.addPage(p));
        }
        const pdfBytes = await out.save();
        const name = files.length===1 ? getBaseName(files[0].file.name) : "merged";
        downloadBlob(new Blob([pdfBytes], {type:"application/pdf"}), `${name}_${Date.now()}.pdf`);
        info.textContent="完了：結合PDFをダウンロードしました";
      }catch(err){ console.error(err); info.textContent="結合に失敗しました"; }
    });

    renderList();
  })();
</script>
</body>
</html>
