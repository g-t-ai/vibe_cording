<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDFãƒ„ãƒ¼ãƒ«ï¼ˆç”»åƒå›è»¢ãƒ»ãƒšãƒ¼ã‚¸åˆ†å‰²ãƒ»çµåˆãƒ»PDFå›è»¢ï¼‰</title>
<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆCDNï¼‰ -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  :root {
    --bg: #0b1020; --panel: #121a2f; --muted: #9fb0d0; --text: #eef3ff;
    --accent: #6aa3ff; --accent-2: #9bffe0; --border: #2a3557;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,"ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN","ãƒ¡ã‚¤ãƒªã‚ª",Arial}
  header{padding:28px 20px;text-align:center}
  header h1{margin:0;letter-spacing:.02em;font-size:clamp(22px,3vw,30px)}
  header p{margin:6px 0 0;color:var(--muted);font-size:14px}
  .container{width:min(1100px,92vw);margin:0 auto 48px;display:grid;gap:16px;grid-template-columns:1fr}
  @media (min-width:980px){.container{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
    border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 8px 28px rgba(0,0,0,.25)}
  .card h2{margin:0 0 12px;font-size:18px;display:flex;align-items:center;gap:8px}
  .sub{color:var(--muted);font-size:13px;margin:8px 0 14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row + .row{margin-top:10px}
  input[type="file"]{display:block;width:100%;padding:10px;border-radius:12px;background:#0f1630;border:1px dashed var(--border);color:var(--muted)}
  input[type="text"]{background:#0f1630;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;width:100%}
  .btn{appearance:none;border:1px solid var(--border);
    background:linear-gradient(180deg,rgba(106,163,255,.22),rgba(106,163,255,.08));
    color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .06s,box-shadow .2s,border-color .2s;font-weight:600}
  .btn:hover{border-color:#3c4d7a;box-shadow:0 6px 18px rgba(106,163,255,.18)}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn.secondary{background:transparent}
  .btn.success{background:linear-gradient(180deg,rgba(155,255,224,.25),rgba(155,255,224,.10))}
  .btn.warning{background:linear-gradient(180deg,rgba(255,210,140,.25),rgba(255,210,140,.10))}
  .preview-wrap{margin-top:12px;background:#0f1630;border:1px solid var(--border);border-radius:12px;padding:12px;display:grid;place-items:center;max-height:360px;overflow:auto}
  canvas,img.preview{max-width:100%;height:auto;border-radius:10px;border:1px solid #203058;background:#0a0f1e}
  .list{margin:8px 0 0;padding:0;list-style:none;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .list li{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#0f1630}
  .list li:last-child{border-bottom:none}
  .file-name{color:var(--text);font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:66%}
  .file-ctrls{display:flex;gap:8px}
  .chip{font-size:12px;color:var(--muted)}
  footer{text-align:center;color:var(--muted);padding:14px 0 28px;font-size:12px}
  .note{color:var(--muted);font-size:12px;line-height:1.6;margin-top:10px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .hint{color:var(--accent-2)}
</style>
</head>
<body>
  <header>
    <h1>PDFãƒ„ãƒ¼ãƒ«ï¼ˆç”»åƒå›è»¢ãƒ»PDFå›è»¢ãƒ»ãƒšãƒ¼ã‚¸åˆ†å‰²ãƒ»çµåˆï¼‰</h1>
    <p>ã™ã¹ã¦ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</p>
  </header>

  <main class="container">
    <!-- ç”»åƒ 90åº¦å›è»¢ -->
    <section class="card" id="img-rotator">
      <h2>ğŸ–¼ï¸ ç”»åƒã‚’90Â°å›è»¢</h2>
      <p class="sub">JPG / PNG / WebP ãªã©ã‚’èª­ã¿è¾¼ã¿ã€90Â°ãšã¤å›è»¢ã—ã¦ä¿å­˜ã€‚</p>
      <input id="imgInput" type="file" accept="image/*" />
      <div class="row">
        <button class="btn" id="rotateBtn">90Â°å›è»¢</button>
        <button class="btn success" id="downloadImgBtn">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <span class="chip" id="imgInfo"></span>
      </div>
      <div class="preview-wrap"><canvas id="imgCanvas"></canvas></div>
      <p class="note">å‡ºåŠ›å½¢å¼ã¯å…ƒç”»åƒã«åˆã‚ã›ã¾ã™ã€‚EXIFã®å‘ãã¯æ­£è¦åŒ–ã€‚</p>
    </section>

    <!-- â˜… æ–°æ©Ÿèƒ½ï¼šPDF ãƒšãƒ¼ã‚¸å›è»¢ -->
    <section class="card" id="pdf-rotator">
      <h2>ğŸ§­ PDFãƒšãƒ¼ã‚¸ã‚’90Â°å›è»¢</h2>
      <p class="sub">PDFã®å…¨ãƒšãƒ¼ã‚¸ã€ã¾ãŸã¯æŒ‡å®šç¯„å›²ã ã‘ã‚’90Â°ï¼ˆæ™‚è¨ˆå›ã‚Šï¼‰å›è»¢ã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚</p>
      <input id="rotatePdfInput" type="file" accept="application/pdf" />
      <div class="row">
        <button class="btn" id="rotateAllPdfBtn">å…¨ãƒšãƒ¼ã‚¸ã‚’90Â°å›è»¢ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
      <div class="row">
        <input id="rotateRangeInput" type="text" placeholder="å›è»¢ã™ã‚‹ãƒšãƒ¼ã‚¸ç¯„å›²ï¼šä¾‹ 1-3,5,7-" />
        <button class="btn success" id="rotateRangePdfBtn">ç¯„å›²ã ã‘90Â°å›è»¢ï¼ˆPDFå‡ºåŠ›ï¼‰</button>
      </div>
      <div class="row"><span class="chip" id="rotatePdfInfo"></span></div>
      <p class="note">ãƒšãƒ¼ã‚¸ç•ªå·ã¯ <b>1 å§‹ã¾ã‚Š</b>ã€‚ä¾‹ï¼š<span class="mono">-2</span>ï¼ˆå…ˆé ­ã€œ2ãƒšãƒ¼ã‚¸ï¼‰ã€<span class="mono">5-</span>ï¼ˆ5ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã™ã¹ã¦ï¼‰ã€‚</p>
    </section>

    <!-- PDF ãƒšãƒ¼ã‚¸åˆ†å‰² -->
    <section class="card" id="pdf-splitter">
      <h2>âœ‚ï¸ PDFãƒšãƒ¼ã‚¸åˆ†å‰²</h2>
      <p class="sub">å…¨ãƒšãƒ¼ã‚¸ã‚’1æšãšã¤ï¼ˆZIPï¼‰ï¼ç¯„å›²æŠ½å‡ºã§1ã¤ã®PDFã‚’ä½œæˆã€‚</p>
      <input id="splitPdfInput" type="file" accept="application/pdf" />
      <div class="row"><button class="btn warning" id="splitAllBtn">å…¨ãƒšãƒ¼ã‚¸ã‚’1æšãšã¤ã«åˆ†å‰²ï¼ˆZIPï¼‰</button></div>
      <div class="row">
        <input id="rangeInput" type="text" placeholder="æŠ½å‡ºã™ã‚‹ãƒšãƒ¼ã‚¸ï¼šä¾‹ 1-3,5,7-8" />
        <button class="btn" id="extractRangeBtn">ç¯„å›²ã‚’æŠ½å‡ºï¼ˆPDFï¼‰</button>
      </div>
      <div class="note">
        ä¾‹ï¼š<span class="mono">1-3,5,7-</span> / <span class="mono">-2</span>
        <br><span class="hint">ãƒšãƒ¼ã‚¸ç•ªå·ã¯ 1 å§‹ã¾ã‚Š</span>
      </div>
      <div class="row"><span class="chip" id="splitInfo"></span></div>
    </section>

    <!-- PDF çµåˆ -->
    <section class="card" id="pdf-merger">
      <h2>ğŸ”— PDFãƒšãƒ¼ã‚¸ã®çµ±åˆï¼ˆçµåˆï¼‰</h2>
      <p class="sub">è¤‡æ•°PDFã‚’é¸ã‚“ã§é †åºèª¿æ•´ â†’ 1ã¤ã«çµåˆã€‚</p>
      <input id="mergePdfInput" type="file" accept="application/pdf" multiple />
      <ul class="list" id="mergeList"></ul>
      <div class="row">
        <button class="btn success" id="mergeBtn">çµåˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <span class="chip" id="mergeInfo"></span>
      </div>
      <p class="note">å„PDFã®ãƒšãƒ¼ã‚¸é †ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚â†‘â†“ã§ä¸¦ã³æ›¿ãˆå¯èƒ½ã€‚</p>
    </section>
  </main>

  <footer>ä½œæˆï¼šã‚ãªãŸã®ç›¸æ£’ChatGPTã€‚å¿…è¦ãªã‚‰ç¸¦æ¨ªåè»¢ãƒ»180Â°/270Â°å¯¾å¿œã‚‚ã™ãè¿½åŠ ã§ãã‚‹ã‚ˆï¼</footer>

<script>
  // ========= å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
  const byId = (id) => document.getElementById(id);
  const formatBytes = (bytes) => {
    if (!bytes && bytes !== 0) return "";
    const units = ["B","KB","MB","GB"];
    let i=0,n=bytes; while(n>=1024 && i<units.length-1){n/=1024;i++}
    return n.toFixed(n>=10||i===0?0:1)+" "+units[i];
  };
  const downloadBlob = (blob, filename) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 200);
  };
  const getBaseName = (name) => name.replace(/\.[^.]+$/, "");
  const readAsArrayBuffer = (file) => new Promise((res, rej) => {
    const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(file);
  });

  // ========= ç”»åƒ 90åº¦å›è»¢ =========
  (function initImageRotate(){
    const imgInput = byId("imgInput");
    const canvas = byId("imgCanvas");
    const ctx = canvas.getContext("2d");
    const rotateBtn = byId("rotateBtn");
    const downloadBtn = byId("downloadImgBtn");
    const info = byId("imgInfo");

    let img = new Image();
    let currentRotation = 0;
    let mime = "image/png";

    function draw(){
      const rad = (currentRotation % 360) * Math.PI / 180;
      const w = img.naturalWidth, h = img.naturalHeight;
      const is90 = (currentRotation/90) % 2 !== 0;
      canvas.width = is90 ? h : w;
      canvas.height = is90 ? w : h;
      ctx.save();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.rotate(rad);
      ctx.drawImage(img, -w/2, -h/2);
      ctx.restore();
      info.textContent = `${canvas.width}Ã—${canvas.height}px`;
    }

    imgInput.addEventListener("change",(e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      mime = file.type || "image/png";
      const url = URL.createObjectURL(file);
      img.onload = ()=>{ currentRotation=0; draw(); URL.revokeObjectURL(url); };
      img.onerror = ()=>{ info.textContent="ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"; };
      img.src = url;
    });

    rotateBtn.addEventListener("click", ()=>{
      if(!img.src){ info.textContent="å…ˆã«ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
      currentRotation = (currentRotation + 90) % 360; draw();
    });

    downloadBtn.addEventListener("click", ()=>{
      if(!img.src){ info.textContent="å…ˆã«ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
      canvas.toBlob((blob)=>{
        if (blob) downloadBlob(blob, `rotated_${Date.now()}.${mime.includes("jpeg")||mime.includes("jpg")?"jpg":(mime.split("/")[1]||"png")}`);
      }, mime);
    });
  })();

  // ========= ãƒšãƒ¼ã‚¸ç¯„å›²ãƒ‘ãƒ¼ã‚µï¼ˆ1å§‹ã¾ã‚Šâ†’0å§‹ã¾ã‚Šé…åˆ—ï¼‰ =========
  function parsePageRanges(input, pageCount){
    if(!input || !pageCount) return [];
    const cleaned = input.replace(/\s+/g,""); if(!cleaned) return [];
    const parts = cleaned.split(",");
    const set = new Set();
    for(const part of parts){
      if(!part) continue;
      const m = part.match(/^(\d+)?-(\d+)?$/);
      if(m){
        let start = m[1] ? parseInt(m[1],10) : 1;
        let end   = m[2] ? parseInt(m[2],10) : pageCount;
        if(start<1) start=1; if(end>pageCount) end=pageCount;
        if(start>end) [start,end] = [end,start];
        for(let p=start; p<=end; p++) set.add(p-1);
      }else{
        const p = parseInt(part,10);
        if(!isNaN(p) && p>=1 && p<=pageCount) set.add(p-1);
      }
    }
    return Array.from(set).sort((a,b)=>a-b);
  }

  // ========= â˜… PDF å›è»¢ï¼ˆ90Â°æ™‚è¨ˆå›ã‚Šï¼‰ =========
  (function initPdfRotate(){
    const input = byId("rotatePdfInput");
    const info = byId("rotatePdfInfo");
    const rotateAllBtn = byId("rotateAllPdfBtn");
    const rotateRangeBtn = byId("rotateRangePdfBtn");
    const rangeInput = byId("rotateRangeInput");

    let file = null;
    let pageCount = 0;

    input.addEventListener("change", async (e)=>{
      file = e.target.files?.[0] ?? null;
      info.textContent = "";
      if(!file) return;
      try{
        const bytes = await readAsArrayBuffer(file);
        const pdf = await PDFLib.PDFDocument.load(bytes);
        pageCount = pdf.getPageCount();
        info.textContent = `${file.name} : ${pageCount}ãƒšãƒ¼ã‚¸, ${formatBytes(file.size)}`;
      }catch(err){
        console.error(err);
        info.textContent = "PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
      }
    });

    async function rotateAndDownload(targetPages /* 0-based array or null for all */){
      if(!file){ info.textContent="å…ˆã«PDFã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
      try{
        info.textContent = "å›è»¢å‡¦ç†ä¸­â€¦";
        const bytes = await readAsArrayBuffer(file);
        const pdfDoc = await PDFLib.PDFDocument.load(bytes);

        const indices = targetPages && targetPages.length>0
          ? targetPages
          : Array.from({length: pdfDoc.getPageCount()}, (_,i)=>i);

        indices.forEach(i=>{
          const page = pdfDoc.getPage(i);
          const current = (page.getRotation()?.angle ?? 0);
          page.setRotation(PDFLib.degrees((current + 90) % 360));
        });

        const outBytes = await pdfDoc.save();
        const base = getBaseName(file.name);
        downloadBlob(new Blob([outBytes], {type:"application/pdf"}), `${base}_rot90_${Date.now()}.pdf`);
        info.textContent = `å®Œäº†ï¼š${indices.length}ãƒšãƒ¼ã‚¸ã‚’90Â°å›è»¢ã—ã¾ã—ãŸ`;
      }catch(err){
        console.error(err);
        info.textContent = "å›è»¢ã«å¤±æ•—ã—ã¾ã—ãŸ";
      }
    }

    rotateAllBtn.addEventListener("click", ()=> rotateAndDownload(null));

    rotateRangeBtn.addEventListener("click", ()=>{
      if(!file){ info.textContent="å…ˆã«PDFã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
      if(!pageCount){ info.textContent="ãƒšãƒ¼ã‚¸æ•°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"; return; }
      const pages = parsePageRanges(rangeInput.value, pageCount);
      if(pages.length===0){ info.textContent="æœ‰åŠ¹ãªãƒšãƒ¼ã‚¸ç¯„å›²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
      rotateAndDownload(pages);
    });
  })();

  // ========= PDF åˆ†å‰² =========
  (function initPdfSplit(){
    const input = byId("splitPdfInput");
    const info = byId("splitInfo");
    const splitAllBtn = byId("splitAllBtn");
    const extractBtn = byId("extractRangeBtn");
    const rangeInput = byId("rangeInput");

    let file = null; let pageCount = 0;
    input.addEventListener("change", async (e)=>{
      file = e.target.files?.[0] ?? null; info.textContent = "";
      if(!file) return;
      try{
        const bytes = await readAsArrayBuffer(file);
        const pdfDoc = await PDFLib.PDFDocument.load(bytes);
        pageCount = pdfDoc.getPageCount();
        info.textContent = `${file.name} : ${pageCount}ãƒšãƒ¼ã‚¸, ${formatBytes(file.size)}`;
      }catch(err){ console.error(err); info.textContent="PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"; }
    });

    splitAllBtn.addEventListener("click", async ()=>{
      if(!file){ info.textContent="å…ˆã«PDFã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
      try{
        info.textContent = "åˆ†å‰²ä¸­â€¦ï¼ˆZIPä½œæˆï¼‰";
        const bytes = await readAsArrayBuffer(file);
        const src = await PDFLib.PDFDocument.load(bytes);
        const zip = new JSZip(); const base = getBaseName(file.name);
        for(let i=0; i<src.getPageCount(); i++){
          const out = await PDFLib.PDFDocument.create();
          const [copied] = await out.copyPages(src, [i]); out.addPage(copied);
          const pdfBytes = await out.save(); zip.file(`${base}_p${i+1}.pdf`, pdfBytes);
        }
        const blob = await zip.generateAsync({type:"blob"});
        saveAs(blob, `${base}_split_${Date.now()}.zip`);
        info.textContent = "å®Œäº†ï¼šZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ";
      }catch(err){ console.error(err); info.textContent="åˆ†å‰²ã«å¤±æ•—ã—ã¾ã—ãŸ"; }
    });

    extractBtn.addEventListener("click", async ()=>{
      if(!file){ info.textContent="å…ˆã«PDFã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
      if(!pageCount){ info.textContent="PDFãƒšãƒ¼ã‚¸æ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"; return; }
      const ranges = parsePageRanges(rangeInput.value, pageCount);
      if(ranges.length===0){ info.textContent="æœ‰åŠ¹ãªãƒšãƒ¼ã‚¸ç¯„å›²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
      try{
        info.textContent = "æŠ½å‡ºä¸­â€¦";
        const bytes = await readAsArrayBuffer(file);
        const src = await PDFLib.PDFDocument.load(bytes);
        const out = await PDFLib.PDFDocument.create();
        const copied = await out.copyPages(src, ranges); copied.forEach(p=>out.addPage(p));
        const pdfBytes = await out.save();
        const base = getBaseName(file.name);
        downloadBlob(new Blob([pdfBytes], {type:"application/pdf"}), `${base}_extract_${Date.now()}.pdf`);
        info.textContent = `å®Œäº†ï¼š${ranges.length}ãƒšãƒ¼ã‚¸æŠ½å‡ºã—ã¾ã—ãŸ`;
      }catch(err){ console.error(err); info.textContent="æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ"; }
    });
  })();

  // ========= PDF çµåˆ =========
  (function initPdfMerge(){
    const input = byId("mergePdfInput");
    const list = byId("mergeList");
    const info = byId("mergeInfo");
    const mergeBtn = byId("mergeBtn");
    let files = [];

    function renderList(){
      list.innerHTML = "";
      files.forEach((f,idx)=>{
        const li=document.createElement("li");
        const name=document.createElement("div"); name.className="file-name"; name.textContent=f.file.name;
        const ctrls=document.createElement("div"); ctrls.className="file-ctrls";
        const up=document.createElement("button"); up.className="btn secondary"; up.textContent="â†‘"; up.title="ä¸Šã¸";
        up.onclick=()=>{ if(idx>0){ const t=files[idx-1]; files[idx-1]=files[idx]; files[idx]=t; renderList(); } };
        const down=document.createElement("button"); down.className="btn secondary"; down.textContent="â†“"; down.title="ä¸‹ã¸";
        down.onclick=()=>{ if(idx<files.length-1){ const t=files[idx+1]; files[idx+1]=files[idx]; files[idx]=t; renderList(); } };
        const del=document.createElement("button"); del.className="btn secondary"; del.textContent="å‰Šé™¤"; del.title="ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤";
        del.onclick=()=>{ files = files.filter(x=>x.id!==f.id); renderList(); };
        ctrls.append(up,down,del); li.append(name,ctrls); list.appendChild(li);
      });
      if(files.length===0){ const li=document.createElement("li"); li.innerHTML='<span class="chip">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</span>'; list.appendChild(li); }
      info.textContent = files.length ? `${files.length}ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠä¸­` : "";
    }

    input.addEventListener("change",(e)=>{
      const sel = Array.from(e.target.files || []);
      for(const f of sel){
        const id = `${f.name}_${f.size}_${f.lastModified}_${Math.random().toString(36).slice(2,8)}`;
        files.push({file:f,id});
      }
      renderList();
    });

    mergeBtn.addEventListener("click", async ()=>{
      if(files.length===0){ info.textContent="PDFã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
      try{
        info.textContent="çµåˆä¸­â€¦";
        const out = await PDFLib.PDFDocument.create();
        for(const f of files){
          const bytes = await readAsArrayBuffer(f.file);
          const src = await PDFLib.PDFDocument.load(bytes);
          const idx = Array.from({length: src.getPageCount()}, (_,i)=>i);
          const copied = await out.copyPages(src, idx);
          copied.forEach(p=>out.addPage(p));
        }
        const pdfBytes = await out.save();
        const name = files.length===1 ? getBaseName(files[0].file.name) : "merged";
        downloadBlob(new Blob([pdfBytes], {type:"application/pdf"}), `${name}_${Date.now()}.pdf`);
        info.textContent="å®Œäº†ï¼šçµåˆPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ";
      }catch(err){ console.error(err); info.textContent="çµåˆã«å¤±æ•—ã—ã¾ã—ãŸ"; }
    });

    renderList();
  })();
</script>
</body>
</html>
